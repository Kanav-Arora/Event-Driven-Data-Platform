services:
  postgres:
    image: postgres:15
    container_name: postgres
    env_file: .env
    restart: always
    command:
      - "postgres"
      - "-c"
      - "wal_level=logical"
      - "-c"
      - "max_wal_senders=10"
      - "-c"
      - "max_replication_slots=10"
      - "-c"
      - "max_connections=200"
    volumes:
      - ./postgres:/docker-entrypoint-initdb.d
    ports:
      - "${POSTGRES_PORT}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - main
  data-generator:
    build:
      context: .
      dockerfile: ./docker/Dockerfile.data-generator
    container_name: data-generator
    restart: "no"
    depends_on:
      postgres:
        condition: service_healthy
    env_file: .env
    networks:
      - main
  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.1
    container_name: zookeeper
    restart: unless-stopped
    env_file: .env
    ports:
      - "2181:2181"
    networks:
      - main
  kafka:
    image: confluentinc/cp-kafka:7.6.1
    container_name: kafka
    env_file: .env
    ports:
      - "9092:9092"
    depends_on:
      - zookeeper
    networks:
      - main
  debezium:
    image: debezium/connect:2.7.3.Final
    container_name: debezium
    depends_on:
      - kafka
      - postgres
    ports:
    - "8083:8083"
    environment:
      BOOTSTRAP_SERVERS: kafka:29092
      GROUP_ID: 1
      CONFIG_STORAGE_TOPIC: debezium_configs
      OFFSET_STORAGE_TOPIC: debezium_offsets
      STATUS_STORAGE_TOPIC: debezium_status
    networks:
      - main
    volumes:
      - ./debezium/connectors:/kafka/connect/etc/connector-templates

  flink-jobmanager:
      build:
          context: ./docker/flink/
          dockerfile: ./Dockerfile.flink
      container_name: flink-jobmanager
      command: jobmanager
      ports:
          - '8081:8081'
      environment:
          - JOB_MANAGER_RPC_ADDRESS=flink-jobmanager
      networks:
          - main
  flink-taskmanager:
      build:
          context: ./docker/flink/
          dockerfile: ./Dockerfile.flink
      container_name: flink-taskmanager
      command: taskmanager
      depends_on:
          - flink-jobmanager
      environment:
          - JOB_MANAGER_RPC_ADDRESS=flink-jobmanager
      networks:
          - main
  jupyter:
      build:
          context: .
          dockerfile: ./docker/Dockerfile.jupyter
      container_name: jupyter
      ports:
          - '8888:8888'
      volumes:
          - ./jupyter/notebooks:/home/jovyan/work
          - ./jupyter/connectors:/opt/flink/lib
      environment:
          - JUPYTER_TOKEN=easy
      networks:
          - main

  fastapi:
      build:
          context: .
          dockerfile: ./docker/Dockerfile.fastapi
      env_file: .env
      container_name: fastapi
      ports:
          - '8000:8000'
      volumes:
        - ./event-emitter:/app
      depends_on:
        postgres:
          condition: service_healthy
      networks:
          - main
  mkdocs:
    build:
      context: .
      dockerfile: ./docker/Dockerfile.docs
    container_name: mkdocs
    ports:
      - "8001:8001"
    volumes:
      - ./docs:/app/docs
      - ./mkdocs.yml:/app/mkdocs.yml

  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.79.0
    container_name: otel-collector
    volumes:
      - ./observability/otel/otel-collector.yaml:/etc/otel-collector-config.yaml:ro
    command: ["--config", "/etc/otel-collector-config.yaml"]
    ports:
      - "4318:4318"
      - "9464:9464"
    networks:
      - observability

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./observability/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./observability/prometheus:/prometheus
    ports:
      - "9090:9090"
    depends_on: [otel-collector]
    networks:
      - observability

  loki:
    image: grafana/loki:2.9.1
    container_name: loki
    volumes:
      - ./observability/loki/loki-config.yaml:/etc/loki/local-config.yaml:ro
      - ./observability/loki:/loki
    ports:
      - "3100:3100"
    networks:
      - observability

  tempo:
    image: grafana/tempo:1.5.0
    container_name: tempo
    volumes:
      - ./observability/tempo/tempo-config.yaml:/etc/tempo/config.yaml:ro
      - ./observability/tempo:/var/tempo
    ports:
      - "3200:3200"
      - "4317:4317"
    networks:
      - observability

  grafana:
    image: grafana/grafana:10.0.0
    container_name: grafana
    env_file: .env
    ports:
      - "3000:3000"
    depends_on: [prometheus, loki, tempo]
    volumes:
      - ./observability/grafana:/var/lib/grafana
    networks:
      - observability

  marquez:
    image: marquezproject/marquez:0.22.0
    container_name: marquez
    ports:
      - "5001:5000"
    networks:
      - observability
    
networks:
  main:
    driver: bridge
  observability:
    driver: bridge